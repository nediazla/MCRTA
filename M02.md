# MCRTA – Módulo 2

# Configuración de Credenciales y Enumeración Inicial en Multi-Cloud

---

## 1. Introducción al Módulo

Este módulo entra directamente en las prácticas esenciales de un operador Red Team en entornos cloud: **autenticación, configuración de acceso, y enumeración inicial de recursos**.  
Sin credenciales configuradas correctamente no hay ataque, y sin enumeración inicial no hay estrategia ofensiva.

Este módulo cubre:

- Configurar AWS CLI, Azure CLI y Google Cloud SDK.
    
- Comprender dónde residen credenciales y cómo se gestionan.
    
- Enumerar identidades, roles y recursos clave en las tres nubes.
    
- Detectar misconfigurations típicas en la fase inicial.
    

Este módulo establece la base para los ataques de escalación, persistencia y chaining del resto del curso.

---

## 2. Configuración de Credenciales en AWS CLI

### 2.1 Instalar AWS CLI

Verificar instalación:

```
aws --version
```

Instalación en Linux:

```
curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
unzip awscliv2.zip
sudo ./aws/install
```

### 2.2 Configurar credenciales

AWS CLI trabaja con dos componentes clave:

- **Access Key ID**
    
- **Secret Access Key**
    

Configurar:

```
aws configure
```

Se solicitarán:

```
AWS Access Key ID [None]: <ID>
AWS Secret Access Key [None]: <SECRET>
Default region name [None]: us-east-1
Default output format [None]: json
```

### 2.3 Ruta donde se guardan las credenciales

AWS almacena credenciales en:

```
~/.aws/credentials
```

Ejemplo:

```
[default]
aws_access_key_id = AKIA123456789
aws_secret_access_key = S3CR3TKEY123456
```

### 2.4 Validar autenticación

```
aws sts get-caller-identity
```

Salida esperada (requiere credenciales válidas):

```
{
  "UserId": "ABCDEFG123456",
  "Account": "123456789012",
  "Arn": "arn:aws:iam::123456789012:user/test"
}
```

---

## 3. Enumeración Inicial en AWS

La enumeración ofensiva en AWS se basa en identificar identidades, permisos y recursos expuestos.

### 3.1 Listar usuarios IAM

```
aws iam list-users
```

### 3.2 Listar roles IAM

```
aws iam list-roles
```

### 3.3 Obtener políticas asociadas a un usuario

```
aws iam list-attached-user-policies --user-name <USER>
```

### 3.4 Enumerar buckets S3

```
aws s3 ls
```

### 3.5 Ver configuraciones de un bucket

```
aws s3api get-bucket-acl --bucket <BUCKET>
```

### 3.6 Enumerar instancias EC2

```
aws ec2 describe-instances
```

### 3.7 Leer metadata de instancia (si tienes shell en una VM)

```
curl http://169.254.169.254/latest/meta-data
```

Esto es crítico para privilege escalation.

---

## 4. Configuración de Credenciales en Azure CLI

### 4.1 Instalar Azure CLI

Verificar instalación:

```
az version
```

Instalación en Linux:

```
curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
```

### 4.2 Iniciar sesión interactiva

```
az login
```

Para entornos Red Team:

- En ejercicios reales puede usarse un **Service Principal**.
    
- En entornos simulados usaremos login estándar.
    

### 4.3 Listar suscripciones

```
az account list --output table
```

### 4.4 Seleccionar una suscripción

```
az account set --subscription "<ID>"
```

---

## 5. Enumeración Inicial en Azure

### 5.1 Enumerar usuarios de Azure AD

```
az ad user list --output table
```

### 5.2 Enumerar grupos

```
az ad group list
```

### 5.3 Enumerar roles asignados a la cuenta

```
az role assignment list --assignee <ID>
```

### 5.4 Enumerar almacenamiento (Blob)

```
az storage account list --output table
```

### 5.5 Enumerar máquinas virtuales

```
az vm list -o table
```

### 5.6 Leer Managed Identity desde una VM

```
curl http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01 -H Metadata:true
```

### 5.7 Enumerar aplicaciones registradas

```
az ad app list
```

---

## 6. Configuración de Credenciales en Google Cloud SDK (gcloud)

### 6.1 Instalar SDK

Verificar instalación:

```
gcloud --version
```

Instalación:

```
curl -O https://dl.google.com/dl/cloudsdk/channels/rapid/downloads/google-cloud-cli-472.0.0-linux-x86_64.tar.gz
tar -xf google-cloud-cli-*.tar.gz
./google-cloud-sdk/install.sh
```

### 6.2 Autenticación

```
gcloud auth login
```

### 6.3 Seleccionar proyecto

```
gcloud config set project <PROJECT_ID>
```

### 6.4 Listar proyectos accesibles

```
gcloud projects list
```

---

## 7. Enumeración Inicial en GCP

### 7.1 Enumerar cuentas de servicio

```
gcloud iam service-accounts list
```

### 7.2 Ver roles asociados a una cuenta de servicio

```
gcloud projects get-iam-policy <PROJECT_ID>
```

### 7.3 Enumerar storage

```
gcloud storage buckets list
```

### 7.4 Ver permisos de un bucket

```
gcloud storage buckets get-iam-policy gs://<BUCKET>
```

### 7.5 Enumerar instancias de Compute Engine

```
gcloud compute instances list
```

### 7.6 Acceso a Metadata Server (una VM comprometida)

```
curl -H "Metadata-Flavor: Google" \
"http://169.254.169.254/computeMetadata/v1/instance/service-accounts/default/token"
```

---

## 8. Indicadores de Misconfiguración Detectables en Fase Inicial

Durante esta enumeración, un operador MCRTA debe estar atento a:

- Políticas IAM con comodines (“*”).
    
- Buckets accesibles públicamente sin autenticación.
    
- Service Accounts con permisos excesivos (GCP).
    
- Roles “Owner” asignados a identidades equivocadas (Azure).
    
- Redes con firewalls demasiado permisivos.
    
- Metadata endpoints accesibles sin restricciones.
    
- IAM PassRole, ServiceAccountImpersonation y AppRole escalables.
    

Estos síntomas suelen anticipar rutas completas de escalación y chaining.

---

## 9. Ejercicio Práctico del Módulo 2 (CTF Inicial)

Este mini-lab debe hacerse en tu entorno controlado.

### 9.1 Objetivo

Enumerar recursos en las tres nubes y encontrar 3 flags:

- Flag 1: Identidad con permisos excesivos en AWS.
    
- Flag 2: Rol de Azure con asignación insegura.
    
- Flag 3: Service Account en GCP con wildcard permission.
    

### 9.2 Indicaciones

En AWS:

```
aws iam list-policies --query 'Policies[?PolicyName==`AdminFullAccess`]'
```

En Azure:

```
az role assignment list --output json | jq '.[] | select(.roleDefinitionName=="Owner")'
```

En GCP:

```
gcloud projects get-iam-policy <PROJECT_ID> | grep -i 'roles/owner'
```

El alumno debe documentar:

- Qué comando usó.
    
- Qué encontró.
    
- Por qué representa riesgo.
    

---

## 10. Resumen Final del Módulo

En este módulo el estudiante aprendió:

- A configurar credenciales en AWS, Azure y GCP.
    
- A verificar sesiones autenticadas.
    
- A enumerar identidades, roles, almacenamiento, instancias y permisos clave.
    
- A detectar indicios de configuraciones débiles que servirán como base para exploits en Módulos 3, 4 y 5.
    
- A realizar su primer CTF básico de enumeración multi-cloud.